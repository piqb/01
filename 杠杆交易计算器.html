<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>杠杆交易计算器 - 结果展示与Excel生成</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        neutral: '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .table-hover-row:hover {
                background-color: rgba(59, 130, 246, 0.05);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-10 text-center">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral mb-2">杠杆交易计算器</h1>
            <p class="text-gray-600">计算盈利和保本止损位，支持网页查看和Excel下载</p>
        </header>
        
        <div class="bg-white rounded-xl shadow-soft p-6 mb-8">
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-neutral mb-4 flex items-center">
                    <i class="fa fa-calculator text-primary mr-2"></i>参数设置
                </h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="initialFund" class="block text-sm font-medium text-gray-700 mb-1">初始资金 (元)</label>
                        <input type="number" id="initialFund" value="100" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition">
                    </div>
                    
                    <div>
                        <label for="leverage" class="block text-sm font-medium text-gray-700 mb-1">杠杆倍数</label>
                        <input type="number" id="leverage" value="3" min="1" step="0.5"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="priceLevels" class="block text-sm font-medium text-gray-700 mb-1">
                            加仓价格水平 (用逗号分隔，例如: 1.0,1.1,1.2,1.3,1.4,1.5)
                        </label>
                        <input type="text" id="priceLevels" value="1.0,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2.0"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition">
                        <p class="text-xs text-gray-500 mt-1">请按升序输入价格水平</p>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="showResultBtn" class="bg-secondary hover:bg-secondary/90 text-white font-medium px-6 py-3 rounded-lg transition flex items-center justify-center">
                    <i class="fa fa-table mr-2"></i>在网页上显示结果
                </button>
                <button id="generateBtn" class="bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg transition flex items-center justify-center">
                    <i class="fa fa-file-excel-o mr-2"></i>生成并下载Excel
                </button>
            </div>
        </div>
        
        <!-- 结果展示区域 -->
        <div id="resultSection" class="hidden mb-8">
            <div class="bg-white rounded-xl shadow-soft p-6">
                <h2 class="text-xl font-semibold text-neutral mb-4 flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>计算结果
                </h2>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">价格位置</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">加仓后总资金</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总持仓单位</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">前期累计盈利</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">保本止损位（约）</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 结果将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-soft p-6">
            <h2 class="text-xl font-semibold text-neutral mb-4 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>使用说明
            </h2>
            <ul class="text-gray-600 space-y-2 list-disc pl-5">
                <li>设置初始资金、杠杆倍数和加仓价格水平</li>
                <li>点击"在网页上显示结果"按钮直接查看计算数据</li>
                <li>点击"生成并下载Excel"按钮获取计算结果表格文件</li>
                <li>表格包含价格位置、加仓后总资金、总持仓单位、前期累计盈利和保本止损位</li>
                <li>价格水平请按升序输入，以确保计算准确性</li>
            </ul>
        </div>
        
        <footer class="mt-10 text-center text-gray-500 text-sm">
            <p>杠杆交易有风险，计算结果仅供参考</p>
        </footer>
    </div>

    <script>
        // 绑定按钮事件
        document.getElementById('showResultBtn').addEventListener('click', showResults);
        document.getElementById('generateBtn').addEventListener('click', generateExcel);
        
        // 在网页上显示结果
        function showResults() {
            // 获取输入参数
            const initialFund = parseFloat(document.getElementById('initialFund').value);
            const leverage = parseFloat(document.getElementById('leverage').value);
            const priceLevels = document.getElementById('priceLevels').value
                .split(',')
                .map(price => parseFloat(price.trim()))
                .sort((a, b) => a - b); // 确保价格按升序排列
            
            // 验证输入
            if (isNaN(initialFund) || initialFund <= 0) {
                alert('请输入有效的初始资金');
                return;
            }
            
            if (isNaN(leverage) || leverage < 1) {
                alert('请输入有效的杠杆倍数（至少为1）');
                return;
            }
            
            if (priceLevels.length === 0 || priceLevels.some(isNaN)) {
                alert('请输入有效的价格水平');
                return;
            }
            
            // 计算数据
            const data = calculateTradingData(initialFund, leverage, priceLevels);
            
            // 显示结果表格
            displayResults(data);
            
            // 滚动到结果区域
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 生成并下载Excel
        function generateExcel() {
            // 获取输入参数
            const initialFund = parseFloat(document.getElementById('initialFund').value);
            const leverage = parseFloat(document.getElementById('leverage').value);
            const priceLevels = document.getElementById('priceLevels').value
                .split(',')
                .map(price => parseFloat(price.trim()))
                .sort((a, b) => a - b); // 确保价格按升序排列
            
            // 验证输入
            if (isNaN(initialFund) || initialFund <= 0) {
                alert('请输入有效的初始资金');
                return;
            }
            
            if (isNaN(leverage) || leverage < 1) {
                alert('请输入有效的杠杆倍数（至少为1）');
                return;
            }
            
            if (priceLevels.length === 0 || priceLevels.some(isNaN)) {
                alert('请输入有效的价格水平');
                return;
            }
            
            // 计算数据
            const data = calculateTradingData(initialFund, leverage, priceLevels);
            
            // 创建Excel并下载
            createAndDownloadExcel(data);
        }
        
        // 计算交易数据
        function calculateTradingData(initialFund, leverage, priceLevels) {
            const results = [];
            let previousTotalFund = initialFund;
            let previousPosition = 0;
            
            priceLevels.forEach((price, index) => {
                let totalFund, position, profit, stopLoss;
                
                if (index === 0) {
                    // 第一个价格点（初始开仓）
                    totalFund = initialFund;
                    position = (totalFund * leverage) / price;
                    profit = 0;
                    stopLoss = price; // 初始位置无盈利，止损即成本价
                } else {
                    // 后续价格点（加仓）
                    const previousPrice = priceLevels[index - 1];
                    const priceChange = price - previousPrice;
                    
                    // 计算当前总资金（上一阶段资金 + 盈利）
                    totalFund = previousTotalFund + (priceChange * previousPosition);
                    
                    // 计算当前持仓量
                    position = (totalFund * leverage) / price;
                    
                    // 计算累计盈利
                    profit = totalFund - initialFund;
                    
                    // 计算保本止损位
                    stopLoss = price - (profit / position);
                }
                
                results.push({
                    price: price,
                    totalFund: totalFund,
                    position: position,
                    profit: profit,
                    stopLoss: stopLoss
                });
                
                // 更新用于下一循环的变量
                previousTotalFund = totalFund;
                previousPosition = position;
            });
            
            return results;
        }
        
        // 在网页上显示结果
        function displayResults(data) {
            const tableBody = document.getElementById('resultTableBody');
            tableBody.innerHTML = ''; // 清空现有内容
            
            // 显示结果区域
            document.getElementById('resultSection').classList.remove('hidden');
            
            // 填充表格数据
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'table-hover-row transition-colors';
                
                // 为第一行添加特殊标识（初始开仓）
                if (index === 0) {
                    row.classList.add('bg-blue-50');
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.price.toFixed(4)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.totalFund.toFixed(4)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.position.toFixed(4)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.profit.toFixed(4)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.stopLoss.toFixed(4)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 创建并下载Excel文件
        function createAndDownloadExcel(data) {
            // 准备工作表数据
            const wsData = [
                ['价格位置', '加仓后总资金', '总持仓单位', '前期累计盈利', '保本止损位（约）'],
                ...data.map(item => [
                    item.price.toFixed(4),
                    item.totalFund.toFixed(4),
                    item.position.toFixed(4),
                    item.profit.toFixed(4),
                    item.stopLoss.toFixed(4)
                ])
            ];
            
            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 设置列宽
            const wscols = [
                {wch: 12}, // 价格位置
                {wch: 15}, // 加仓后总资金
                {wch: 15}, // 总持仓单位
                {wch: 15}, // 前期累计盈利
                {wch: 18}  // 保本止损位（约）
            ];
            ws['!cols'] = wscols;
            
            // 将工作表添加到工作簿
            XLSX.utils.book_append_sheet(wb, ws, "杠杆交易计算");
            
            // 生成并下载Excel文件
            XLSX.writeFile(wb, "杠杆交易计算表.xlsx");
        }
    </script>
</body>
</html>
